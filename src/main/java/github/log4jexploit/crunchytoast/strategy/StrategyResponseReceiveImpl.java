/*
 * Copyright (c) 2024 CrunchyToast by Log4JExploit
 * Do you keep my non-compiled source code?
 * Then keep this comment.  (View the license)
 */

package github.log4jexploit.crunchytoast.strategy;

import github.log4jexploit.crunchytoast.exceptions.HttpProtocolException;
import github.log4jexploit.crunchytoast.http.util.UncheckedIOReader;
import github.log4jexploit.crunchytoast.general.Client;
import github.log4jexploit.crunchytoast.http.message.inf.HttpResponse;
import github.log4jexploit.crunchytoast.http.message.inf.Strategy;
import github.log4jexploit.crunchytoast.http.util.Http;

public class StrategyResponseReceiveImpl implements Strategy.Response {

    private UncheckedIOReader reader;
    private HttpResponse response;

    @Override
    public void initialize(Client client, HttpResponse response) {
        this.reader = new UncheckedIOReader(client.getInputStream());
        this.response = response;
    }

    @Override
    public void execute() {
        String line = reader.nextLine(
                response.getSecurityPolicy().getMaxLineLength()
        );

        try {
            line = line.trim();
            if(!line.toUpperCase().startsWith(response.getProtocol().toUpperCase()))
                throw new HttpProtocolException("Protocols don't match up!");

            String[] split = line.split(" ");
            this.response.setResponseCode(Http.ResponseCode.values()[0].byString(split[1]));
        } catch (Exception e) {
            throw new HttpProtocolException("Error parsing request header: "+e.getClass().getSimpleName());
        }
    }
}
