/*
 * Copyright (c) 2022-2024 CrunchyToast by Log4JExploit
 * Do you keep my non-compiled source code?
 * Then keep this comment.  (View the license)
 */

package github.log4jexploit.crunchytoast.strategy;

import github.log4jexploit.crunchytoast.exceptions.HttpProtocolException;
import github.log4jexploit.crunchytoast.http.message.inf.HttpResponse;
import github.log4jexploit.crunchytoast.http.util.Http;
import github.log4jexploit.crunchytoast.http.util.UncheckedIOReader;
import github.log4jexploit.crunchytoast.server.Client;

public class StrategyResponseReceiveImpl implements Strategy.Response {

    private UncheckedIOReader reader;
    private HttpResponse response;

    @Override
    public void initialize(Client client, HttpResponse response) {
        this.reader = new UncheckedIOReader(client.getInputStream());
        this.response = response;
    }

    @Override
    public void execute() {
        String line = reader.nextLine(
                response.getSecurityPolicy().getMaxLineLength()
        ).trim().toUpperCase();

        if(!line.startsWith(response.getProtocol().toUpperCase()))
            throw new HttpProtocolException("Protocols don't match up! Response Protocol: "+line.split(" ")[0]);

        String[] split = line.split(" ");
        this.response.setResponseCode(Http.ResponseCode.values()[0].byString(split[1]));
    }
}
