/*
 * Copyright (c) 2024 CrunchyToast by Log4JExploit
 * Do you keep my non-compiled source code?
 * Then keep this comment.  (View the license)
 */

package github.log4jexploit.crunchytoast.http.message.body.impl;

import github.log4jexploit.crunchytoast.http.message.body.inf.IBodyChunked;
import github.log4jexploit.crunchytoast.http.message.inf.Strategy;
import github.log4jexploit.crunchytoast.http.util.Http;
import github.log4jexploit.crunchytoast.http.util.UncheckedIOReader;
import github.log4jexploit.crunchytoast.http.util.UtilChunks;

import java.io.InputStream;

public class BodyContentReaderChunked implements IBodyChunked.Reader {

    private final Http.Encoding[] encodings;
    private final Strategy.Message strategy;
    private final UtilChunks util;
    private final InputStream in;

    private boolean endOfStream;
    private int counter;


    public BodyContentReaderChunked(Strategy.Message strategy, InputStream in, Http.Encoding[] encodings) {
        this.encodings = encodings;
        this.strategy = strategy;
        this.in = in;
        this.util = new UtilChunks();
        this.counter = 0;
    }


    @Override
    public byte[] readNextChunk() {
        if(endOfStream)
            return new byte[0];

        byte[] encodedData = util.readEncodedChunk(in);
        counter += encodedData.length;

        if(encodedData.length == 0) {
            endOfStream = true;
            this.strategy.executeTrailers();
        }

        return encodedData;
    }

    @Override
    public void onFlushRemaining() {
        byte[] chunk;
        do {
          chunk = readNextChunk();
        } while(chunk.length != 0);
    }

    @Override
    public Http.Encoding[] getEncodings() {
        return this.encodings;
    }

    @Override
    public int getContentLength() {
        return this.counter;
    }

    @Override
    public InputStream getInputStream() {
        return this.in;
    }

    @Override
    public UncheckedIOReader getReader() {
        return null;
    }

    @Override
    public void decode() {
        // Do nothing
    }
}
